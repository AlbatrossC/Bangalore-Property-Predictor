<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangalore Property Predictor</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Integrated CSS for simplicity */
        :root { --primary: #2c3e50; --secondary: #27ae60; --light: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f7f6; }
        
        /* Sidebar */
        .sidebar { width: 350px; background: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 20px; border-bottom: 2px solid var(--secondary); padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        /* Radio Switches */
        .switch-field { display: flex; overflow: hidden; border: 1px solid #ddd; border-radius: 5px; }
        .switch-field input { position: absolute !important; clip: rect(0, 0, 0, 0); height: 1px; width: 1px; border: 0; overflow: hidden; }
        .switch-field label { background-color: #fff; color: rgba(0, 0, 0, 0.6); font-size: 14px; line-height: 1; text-align: center; padding: 8px 16px; margin-right: -1px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px rgba(255, 255, 255, 0.1); transition: all 0.1s ease-in-out; flex: 1; cursor: pointer; }
        .switch-field input:checked + label { background-color: var(--secondary); color: white; box-shadow: none; }
        
        button.submit { width: 100%; background: var(--secondary); color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        button.submit:hover { background: #219150; }

        #uiEstimatedPrice { margin-top: 20px; padding: 15px; background: var(--light); border-radius: 5px; text-align: center; border-left: 5px solid var(--secondary); }
        
        /* Main Content & Map */
        .main-content { flex: 1; position: relative; display: flex; flex-direction: column; }
        #map { flex: 1; width: 100%; height: 100%; }
        
        /* Nearby Controls Overlay */
        .map-overlay { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 999; width: 300px; max-height: 90vh; display: flex; flex-direction: column; }
        .amenity-buttons { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .amenity-btn { flex: 1; padding: 8px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
        .amenity-btn:hover { background: #eee; }
        .amenity-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); }
        
        .places-list { overflow-y: auto; flex: 1; margin-top: 10px; }
        .place-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; cursor: pointer; }
        .place-item:hover { background: #f0f8ff; }
        .loading { text-align: center; color: #666; display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><i class="fas fa-home"></i> Bangalore Homes</div>
    
    <form id="predictForm">
        <div class="form-group">
            <label>Location</label>
            <select id="uiLocations">
                <option value="" disabled selected>Loading locations...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Total Sqft</label>
            <input type="text" id="uiSqft" value="1000">
        </div>

        <div class="form-group">
            <label>BHK</label>
            <div class="switch-field">
                <input type="radio" id="bhk-1" name="uiBHK" value="1"/> <label for="bhk-1">1</label>
                <input type="radio" id="bhk-2" name="uiBHK" value="2" checked/> <label for="bhk-2">2</label>
                <input type="radio" id="bhk-3" name="uiBHK" value="3"/> <label for="bhk-3">3</label>
                <input type="radio" id="bhk-4" name="uiBHK" value="4"/> <label for="bhk-4">4</label>
            </div>
        </div>

        <div class="form-group">
            <label>Bathrooms</label>
            <div class="switch-field">
                <input type="radio" id="bath-1" name="uiBath" value="1"/> <label for="bath-1">1</label>
                <input type="radio" id="bath-2" name="uiBath" value="2" checked/> <label for="bath-2">2</label>
                <input type="radio" id="bath-3" name="uiBath" value="3"/> <label for="bath-3">3</label>
            </div>
        </div>
        
        <div class="form-group">
            <label>Age (Years)</label>
            <input type="range" id="uiAge" min="0" max="30" value="5" oninput="document.getElementById('ageVal').innerText = this.value">
            <span id="ageVal">5</span>
        </div>

        <button type="button" class="submit" onclick="estimatePrice()">Estimate Price</button>
    </form>

    <div id="uiEstimatedPrice">
        <h3>Price: ₹ <span id="priceValue">-</span> Lakh</h3>
    </div>
</div>

<div class="main-content">
    <div id="map"></div>
    
    <div class="map-overlay">
        <h4><i class="fas fa-map-marked-alt"></i> Nearby Amenities</h4>
        <div class="amenity-buttons">
            <button class="amenity-btn" onclick="fetchNearby('school')"><i class="fas fa-school"></i> School</button>
            <button class="amenity-btn" onclick="fetchNearby('hospital')"><i class="fas fa-hospital"></i> Health</button>
            <button class="amenity-btn" onclick="fetchNearby('mall')"><i class="fas fa-shopping-bag"></i> Mall</button>
            <button class="amenity-btn" onclick="fetchNearby('restaurant')"><i class="fas fa-utensils"></i> Food</button>
        </div>
        <div class="loading" id="loadingSpinner"><i class="fas fa-spinner fa-spin"></i> Searching...</div>
        <div class="places-list" id="nearbyList">
            <small style="color: #888;">Select a location and category to see nearby places.</small>
        </div>
    </div>
</div>

<!-- JS Scripts -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
    // 1. Map Initialization
    var map = L.map('map').setView([12.9716, 77.5946], 12); // Bangalore center
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var mainMarker = null;
    var nearbyMarkers = L.layerGroup().addTo(map);
    var currentLat = null;
    var currentLon = null;

    // 2. Load Locations on Startup
    function onPageLoad() {
        $.get("/get_location_names", function(data) {
            if(data && data.locations) {
                var uiLocations = document.getElementById("uiLocations");
                $('#uiLocations').empty();
                uiLocations.add(new Option("Choose a Location", ""));
                for(var i in data.locations) {
                    uiLocations.add(new Option(data.locations[i], data.locations[i]));
                }
            }
        });
    }
    window.onload = onPageLoad;

    // 3. Handle Location Selection
    $('#uiLocations').on('change', function() {
        var location = this.value;
        if(!location) return;

        // Fetch Coordinates
        $.get("/get_location_coords", {location: location}, function(data) {
            if(data.lat && data.lon) {
                currentLat = data.lat;
                currentLon = data.lon;

                // Update Map
                map.flyTo([currentLat, currentLon], 15);
                
                if(mainMarker) map.removeLayer(mainMarker);
                mainMarker = L.marker([currentLat, currentLon]).addTo(map)
                    .bindPopup(`<b>${location}</b>`).openPopup();

                // Clear previous nearby results
                nearbyMarkers.clearLayers();
                document.getElementById("nearbyList").innerHTML = '<small>Click an amenity button above.</small>';
            }
        }).fail(function() {
            alert("Could not fetch coordinates for this location.");
        });
    });

    // 4. Estimate Price Logic
    function estimatePrice() {
        var sqft = document.getElementById("uiSqft").value;
        var bhk = document.querySelector('input[name="uiBHK"]:checked').value;
        var bath = document.querySelector('input[name="uiBath"]:checked').value;
        var location = document.getElementById("uiLocations").value;
        var age = document.getElementById("uiAge").value;
        var estPrice = document.getElementById("priceValue");

        if(!location) {
            alert("Please select a location");
            return;
        }

        $.ajax({
            url: "/predict_price",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                total_sqft: parseFloat(sqft),
                bhk: parseInt(bhk),
                bath: parseInt(bath),
                location: location,
                property_age: parseInt(age)
            }),
            success: function(data) {
                estPrice.innerHTML = data.estimated_price;
            },
            error: function(err) {
                console.log(err);
                estPrice.innerHTML = "Error";
            }
        });
    }

    // 5. Fetch Nearby Places (Overpass)
    function fetchNearby(type) {
        if(!currentLat || !currentLon) {
            alert("Please select a location first!");
            return;
        }

        // UI Updates
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("nearbyList").innerHTML = "";
        nearbyMarkers.clearLayers();
        
        // Icons
        const icons = {
            school: 'graduation-cap',
            hospital: 'hospital',
            mall: 'shopping-bag',
            restaurant: 'utensils'
        };
        const iconClass = icons[type] || 'map-marker';

        $.get("/get_nearby_places", {
            lat: currentLat, 
            lon: currentLon, 
            type: type,
            radius: 2000 
        }, function(data) {
            document.getElementById("loadingSpinner").style.display = "none";
            var listHtml = "";

            if(data.places && data.places.length > 0) {
                data.places.forEach(function(place, index) {
                    // Add List Item
                    listHtml += `<div class="place-item" onclick="focusPlace(${place.lat}, ${place.lon})">
                        <i class="fas fa-${iconClass}"></i> <b>${place.name}</b>
                    </div>`;

                    // Add Marker
                    var marker = L.circleMarker([place.lat, place.lon], {
                        radius: 6,
                        fillColor: "#ff7800",
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(place.name);
                    nearbyMarkers.addLayer(marker);
                });
            } else {
                listHtml = "<div style='padding:10px'>No places found nearby.</div>";
            }
            document.getElementById("nearbyList").innerHTML = listHtml;
        }).fail(function() {
            document.getElementById("loadingSpinner").style.display = "none";
            alert("Failed to fetch nearby places.");
        });
    }

    function focusPlace(lat, lon) {
        map.flyTo([lat, lon], 17);
    }
</script>

</body>
</html>